#!/bin/sh -x

# create database with name as dish_test
DATABASE_NAME='dish_test'
if psql -lqt | cut -d \| -f 1 | grep -qw $DATABASE_NAME; then
    echo "A database with the name $DBNAME already exists."
    echo "Drop $DATABASE_NAME and create a new one."
    dropdb $DATABASE_NAME
fi
createdb $DATABASE_NAME

# Export the environment variables and set up for the server
export DATABASE_URL='postgresql://localhost:5432/dish_test' 
export ADMIN_TOKEN='eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik56RXpNemt6UmtFMVFrTkdSREF5TkRJek1Ea3hSRGhFT1RJNFJFWTJNek5HUWtaRFJUY3dSQSJ9.eyJpc3MiOiJodHRwczovL2Rldi1hdXRoMi5hdXRoMC5jb20vIiwic3ViIjoiYXV0aDB8NWU2NDg2NDVjNmRiYzkwZDNkZTJkMDdjIiwiYXVkIjoiRGlzaGVzIiwiaWF0IjoxNTkyNzE1Mjk4LCJleHAiOjE1OTI4MDE2OTgsImF6cCI6ImVDYzRCdGM2RU9OY1VMYTFzY0VXaUlCMzJ4M1BaeEJkIiwic2NvcGUiOiIiLCJwZXJtaXNzaW9ucyI6WyJkZWxldGU6Y2F0ZWdvcmllcyIsImRlbGV0ZTpkaXNoZXMiLCJkZWxldGU6cmVzdGF1cmFudHMiLCJnZXQ6Y2F0ZWdvcmllcyIsImdldDpkaXNoZXMiLCJnZXQ6cmVzdGF1cmFudHMiLCJwYXRjaDpjYXRlZ29yaWVzIiwicGF0Y2g6ZGlzaGVzIiwicGF0Y2g6cmVzdGF1cmFudHMiLCJwb3N0OmNhdGVnb3JpZXMiLCJwb3N0OmRpc2hlcyIsInBvc3Q6cmVzdGF1cmFudHMiXX0.ZXEiVQKD9CSFTjLwGwHMun2tqn2vCbtsrObPfWiMMDiTS1ZrUd5MjYK6jqeDTHS52dwOQQns2T2U44lcTLxXm6cLlI9QssNAt3tXGzSPssmKO-RhBPUSqMJonnrKDk-fQDAgu6kifCzmqb_uJ3e2C0RpKaM6GyShNiW5EW4CcXffGuuHAS4BsweORWpMOzLYdG4BU-0_GxKDKEHH16s-wK1KK6LqDOtgoob9XxCcQBZGxExS2SXIyZZZTfXTX1DyNsHIccS7QqH1dLqfe41u0eQ1ze_ACAd1m-1LSi-2ZZ_fO6m_GUOkXsgKiM_DfuKp7A6bFyora-ttqHxsN20JXQ'
export USER_TOKEN='eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik56RXpNemt6UmtFMVFrTkdSREF5TkRJek1Ea3hSRGhFT1RJNFJFWTJNek5HUWtaRFJUY3dSQSJ9.eyJpc3MiOiJodHRwczovL2Rldi1hdXRoMi5hdXRoMC5jb20vIiwic3ViIjoiYXV0aDB8NWU5NTVhN2MzNDdlYjAwYzE3MThhM2MzIiwiYXVkIjoiRGlzaGVzIiwiaWF0IjoxNTkyNzE1MzQ0LCJleHAiOjE1OTI4MDE3NDQsImF6cCI6ImVDYzRCdGM2RU9OY1VMYTFzY0VXaUlCMzJ4M1BaeEJkIiwic2NvcGUiOiIiLCJwZXJtaXNzaW9ucyI6WyJnZXQ6Y2F0ZWdvcmllcyIsImdldDpkaXNoZXMiLCJnZXQ6cmVzdGF1cmFudHMiXX0.afD-CNrVl6njvCCEcEpDdPmTurYYQcUoq3PB5soqDBAnCr4Z6D5wkyP3a0dfngawUK9lPizd-CnzQtEkeoE8OILsSEA_6sCP3nxuB2bSImr5FDA5dzw0l8XrPSt9NYicYM2GkuFcOVyH_iJrKz5rWlJnv23GweP3E527qnE6TK-xupLJp7KXE7Egb0GgFWPptah-gyzbRKH_5a5YIhvOibCsKFN-y3unmBVVLXvr7KBfPuKocLrWZ-8-mUDcAv6svArK-6gh4HFpeKY_M5bal588rWAuBsus_IBZVpJd0Y1iCxYXfeMM9MytcGUHtSo6kxecnkT0_CkbXjWsLXBMAA' 
python3 -m backend.src.test -v