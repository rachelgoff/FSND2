#!/bin/sh -x

# create database with name as dish_test
DATABASE_NAME='dish_test'
if psql -lqt | cut -d \| -f 1 | grep -qw $DATABASE_NAME; then
    echo "A database with the name $DBNAME already exists."
    echo "Drop $DATABASE_NAME and create a new one."
    dropdb $DATABASE_NAME
fi
createdb $DATABASE_NAME

# Export the environment variables and set up for the server
export DATABASE_URL='postgresql://localhost:5432/dish_test' 
export ADMIN_TOKEN='eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik56RXpNemt6UmtFMVFrTkdSREF5TkRJek1Ea3hSRGhFT1RJNFJFWTJNek5HUWtaRFJUY3dSQSJ9.eyJpc3MiOiJodHRwczovL2Rldi1hdXRoMi5hdXRoMC5jb20vIiwic3ViIjoiYXV0aDB8NWU2NDg2NDVjNmRiYzkwZDNkZTJkMDdjIiwiYXVkIjoiRGlzaGVzIiwiaWF0IjoxNTkyNzE3Njk0LCJleHAiOjE1OTI4MDQwOTQsImF6cCI6ImVDYzRCdGM2RU9OY1VMYTFzY0VXaUlCMzJ4M1BaeEJkIiwic2NvcGUiOiIiLCJwZXJtaXNzaW9ucyI6WyJkZWxldGU6Y2F0ZWdvcmllcyIsImRlbGV0ZTpkaXNoZXMiLCJkZWxldGU6cmVzdGF1cmFudHMiLCJnZXQ6Y2F0ZWdvcmllcyIsImdldDpkaXNoZXMiLCJnZXQ6cmVzdGF1cmFudHMiLCJwYXRjaDpjYXRlZ29yaWVzIiwicGF0Y2g6ZGlzaGVzIiwicGF0Y2g6cmVzdGF1cmFudHMiLCJwb3N0OmNhdGVnb3JpZXMiLCJwb3N0OmRpc2hlcyIsInBvc3Q6cmVzdGF1cmFudHMiXX0.a9Xw8crUqJ75tPuNGlch7g6XnlXxyBAva6G5worAAzVq_AkPziTnw1uh-ppMkSqFgb1ME6RrfKoix-NFdmJWCTyCPUqe3eXddinLO7kl4WuuK6iPWhl1A4t9phqVJhkxBSVV6f6_qtJP_WorCQdCBJH2_vaQ1hiMi-nWnfEM0QwAxUas8jeA5NL8fBzpCcdas8O08z0UuYq2Qe6i_P6NMGMDzxcIqogeB-7lLXcgGy1ewrM1XQJshpIRoFBqaQQiNyF6tf7Ka-4sY_a7hq2pj7kZ3ZHNqnWUYoFSWSS194aah1E4-ARDbsBoa09fwTZEELpclH_NNTAj3-7F3swibg'
export USER_TOKEN='eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik56RXpNemt6UmtFMVFrTkdSREF5TkRJek1Ea3hSRGhFT1RJNFJFWTJNek5HUWtaRFJUY3dSQSJ9.eyJpc3MiOiJodHRwczovL2Rldi1hdXRoMi5hdXRoMC5jb20vIiwic3ViIjoiYXV0aDB8NWU5NTVhN2MzNDdlYjAwYzE3MThhM2MzIiwiYXVkIjoiRGlzaGVzIiwiaWF0IjoxNTkyNzE3NzM2LCJleHAiOjE1OTI4MDQxMzYsImF6cCI6ImVDYzRCdGM2RU9OY1VMYTFzY0VXaUlCMzJ4M1BaeEJkIiwic2NvcGUiOiIiLCJwZXJtaXNzaW9ucyI6WyJnZXQ6Y2F0ZWdvcmllcyIsImdldDpkaXNoZXMiLCJnZXQ6cmVzdGF1cmFudHMiXX0.nq3Vci-hhSCndP8AeOSgEVtWEdnSfKjxYDEQdU6Wv3USw3BWFhdpYWM1at-JkfZbqy1JRzOAk6HyJRDoUM-b7Ke84bXzxPG7yMZjui8NYZ-202PLpbjwnUZnsBzJdyxHiR_PEGtMsd_HL7hxdh5tToB_7Q9CxBN3e49HYHCxvT3seT2jMBVIJzkHKbJWAwHEQCByDHWGzth3AuYJNYVzwX-fXUsDJZTu59LExi7v7oS-Mzuor7-p3dBeFI6HYY3jzXwFO7FbzCf7KuCw9397STZPBc5X_-xzgC9cCOLhnFlElVkZe91EkQGUo7K8CaDz5ntLoNZ8NFmlU4IJtN4icQ' 
python3 -m backend.src.test -v